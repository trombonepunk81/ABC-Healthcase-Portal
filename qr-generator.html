<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ABC Healthcare QR Code Generator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=Instrument+Serif:ital@0;1&display=swap" rel="stylesheet">
    <style>
        :root {
            --slate-900: #0f172a;
            --slate-800: #1e293b;
            --slate-700: #334155;
            --slate-600: #475569;
            --slate-400: #94a3b8;
            --slate-200: #e2e8f0;
            --slate-100: #f1f5f9;
            --slate-50: #f8fafc;
            --teal-600: #0d9488;
            --teal-500: #14b8a6;
            --teal-400: #2dd4bf;
            --white: #ffffff;
            --shadow-strong: 0 16px 48px -12px rgba(15, 23, 42, 0.25);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--slate-100);
            min-height: 100vh;
            color: var(--slate-800);
        }

        .header {
            background: linear-gradient(135deg, var(--slate-900) 0%, var(--slate-700) 100%);
            padding: 2.5rem 2rem 3.5rem;
            text-align: center;
        }

        .logo-badge {
            display: inline-flex;
            align-items: center;
            background: rgba(255,255,255,0.1);
            padding: 0.5rem 1rem;
            border-radius: 50px;
            margin-bottom: 1.25rem;
        }

        .logo-badge span {
            font-size: 0.75rem;
            font-weight: 600;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            color: var(--teal-400);
        }

        h1 {
            font-family: 'Instrument Serif', serif;
            font-size: 2.5rem;
            font-weight: 400;
            color: white;
            margin-bottom: 0.5rem;
        }

        .subtitle { font-size: 1rem; color: var(--slate-400); }

        .main-content {
            max-width: 1000px;
            margin: -2rem auto 3rem;
            padding: 0 1.5rem;
        }

        .card {
            background: white;
            border-radius: 20px;
            box-shadow: var(--shadow-strong);
            padding: 2rem;
        }

        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .tab {
            padding: 0.625rem 1.25rem;
            border: 1px solid var(--slate-200);
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.875rem;
        }

        .tab.active {
            background: var(--slate-800);
            color: white;
            border-color: var(--slate-800);
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .form-group { margin-bottom: 1.25rem; }

        .form-label {
            display: block;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--slate-500);
            margin-bottom: 0.5rem;
        }

        .form-input, .batch-textarea {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 1px solid var(--slate-200);
            border-radius: 10px;
            font-family: inherit;
            font-size: 0.95rem;
        }

        .batch-textarea {
            min-height: 150px;
            font-family: monospace;
            font-size: 0.85rem;
        }

        .form-hint {
            font-size: 0.75rem;
            color: var(--slate-400);
            margin-top: 0.375rem;
        }

        .generate-btn {
            display: block;
            width: 100%;
            padding: 1rem;
            border: none;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--teal-600), var(--teal-500));
            color: white;
            font-family: inherit;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }

        .generate-btn:hover { opacity: 0.9; }

        .import-section {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1.25rem;
            flex-wrap: wrap;
        }

        .import-btn, .template-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.25rem;
            border-radius: 10px;
            font-family: inherit;
            font-size: 0.9rem;
            cursor: pointer;
        }

        .import-btn {
            border: 2px dashed var(--teal-400);
            background: rgba(20,184,166,0.05);
            color: var(--teal-600);
            font-weight: 600;
        }

        .template-btn {
            border: 1px solid var(--slate-200);
            background: white;
            color: var(--slate-600);
        }

        .output-section {
            display: none;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid var(--slate-200);
        }

        .output-section.active { display: block; }

        .qr-preview {
            background: white;
            border: 1px solid var(--slate-200);
            border-radius: 16px;
            padding: 1.5rem;
            text-align: center;
            display: inline-block;
        }

        .qr-asset-label {
            margin-top: 1rem;
            font-size: 1.1rem;
            font-weight: 700;
        }

        .batch-results {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .batch-item {
            background: white;
            border: 1px solid var(--slate-200);
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
        }

        .batch-item-label {
            margin-top: 0.75rem;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .batch-item-download {
            margin-top: 0.5rem;
            padding: 0.5rem 0.75rem;
            border: none;
            border-radius: 6px;
            background: var(--slate-100);
            cursor: pointer;
            font-size: 0.75rem;
        }

        .download-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.25rem;
            border: none;
            border-radius: 10px;
            background: var(--slate-800);
            color: white;
            font-family: inherit;
            cursor: pointer;
            margin-bottom: 1rem;
        }

        .footer {
            text-align: center;
            padding: 2rem;
            color: var(--slate-400);
            font-size: 0.8rem;
        }

        .footer a { color: var(--slate-400); text-decoration: none; }

        .debug-box {
            background: #111;
            color: #0f0;
            padding: 1rem;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.7rem;
            margin-top: 1rem;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo-badge"><span>üîß Admin Tools</span></div>
        <h1>QR Code Generator</h1>
        <p class="subtitle">Generate asset QR codes for the Help Center portal</p>
    </header>

    <main class="main-content">
        <div class="card">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('single')">Single QR Code</button>
                <button class="tab" onclick="switchTab('batch')">Batch Generate</button>
            </div>

            <!-- Single Tab -->
            <div id="single-tab" class="tab-content active">
                <div class="form-group">
                    <label class="form-label">Asset ID</label>
                    <input type="text" id="asset-id" class="form-input" placeholder="e.g., CAM.E1879-A.01">
                </div>

                <div class="form-group">
                    <label class="form-label">Tandem URL</label>
                    <input type="text" id="tandem-url" class="form-input" placeholder="https://tandem.autodesk.com/...">
                </div>

                <button class="generate-btn" onclick="generateSingleQR()">Generate QR Code</button>

                <div id="single-output" class="output-section">
                    <div class="qr-preview">
                        <canvas id="qr-canvas"></canvas>
                        <div class="qr-asset-label" id="qr-asset-label"></div>
                    </div>
                    <p style="margin-top:1rem; color: var(--slate-500);" id="qr-full-url"></p>
                    <button class="download-btn" onclick="downloadSingleQR()">Download PNG</button>
                </div>

                <div id="debug-single" class="debug-box" style="display:none;"></div>
            </div>

            <!-- Batch Tab -->
            <div id="batch-tab" class="tab-content">
                <div class="import-section">
                    <button class="import-btn" onclick="document.getElementById('excel-file').click()">
                        üìä Import Excel
                    </button>
                    <input type="file" id="excel-file" accept=".xlsx,.xls" style="display:none" onchange="importExcel(event)">
                    <button class="template-btn" onclick="downloadTemplate()">‚¨áÔ∏è Download Template</button>
                </div>

                <div class="form-group">
                    <label class="form-label">Asset Data (one per line: AssetID, URL)</label>
                    <textarea id="batch-data" class="batch-textarea" placeholder="CAM.E1879-A.01, https://tandem.autodesk.com/..."></textarea>
                </div>

                <button class="generate-btn" onclick="generateBatchQR()">Generate All QR Codes</button>

                <div id="batch-output" class="output-section">
                    <button class="download-btn" onclick="downloadAllZip()">Download All (ZIP)</button>
                    <div id="batch-results" class="batch-results"></div>
                </div>

                <div id="debug-batch" class="debug-box" style="display:none;"></div>
            </div>
        </div>
    </main>

    <footer class="footer">
        ¬© 2025 ABC Healthcare ¬∑ QR Code Generator
        <br><a href="index.html">‚Üê Back to Help Center Portal</a>
    </footer>

    <!-- QR Code library - try multiple CDNs -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script>
        // Fallback if jsdelivr fails
        if (typeof QRCode === 'undefined') {
            document.write('<script src="https://unpkg.com/qrcode@1.5.3/build/qrcode.min.js"><\/script>');
        }
    </script>
    <script>
        // Second fallback
        if (typeof QRCode === 'undefined') {
            document.write('<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"><\/script>');
        }
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <script>
        // Check library status on load
        window.addEventListener('DOMContentLoaded', function() {
            console.log('=== Library Check ===');
            console.log('QRCode:', typeof QRCode);
            console.log('JSZip:', typeof JSZip);
            console.log('XLSX:', typeof XLSX);
            
            if (typeof QRCode === 'undefined') {
                alert('WARNING: QR Code library failed to load. This may be due to network restrictions. Please check your internet connection or try a different network.');
            }
        });
        
        const PORTAL_URL = 'https://trombonepunk81.github.io/ABC-Healthcase-Portal/';
        let currentQR = null;
        let batchQRs = [];

        function log(id, msg) {
            const el = document.getElementById(id);
            el.style.display = 'block';
            el.textContent += msg + '\n';
            console.log(msg);
        }

        function clearLog(id) {
            const el = document.getElementById(id);
            el.textContent = '';
            el.style.display = 'none';
        }

        function switchTab(name) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(name + '-tab').classList.add('active');
        }

        function buildUrl(assetId, tandemUrl) {
            return PORTAL_URL + '?asset=' + encodeURIComponent(assetId) + '&tandem=' + encodeURIComponent(tandemUrl);
        }

        async function generateSingleQR() {
            clearLog('debug-single');
            log('debug-single', '=== Starting Single QR Generation ===');

            const assetId = document.getElementById('asset-id').value.trim();
            const tandemUrl = document.getElementById('tandem-url').value.trim();

            log('debug-single', 'Asset ID: ' + assetId);
            log('debug-single', 'Tandem URL: ' + tandemUrl);

            if (!assetId || !tandemUrl) {
                alert('Please fill in both fields');
                return;
            }

            const fullUrl = buildUrl(assetId, tandemUrl);
            log('debug-single', 'Full URL length: ' + fullUrl.length);

            try {
                log('debug-single', 'QRCode library loaded: ' + (typeof QRCode !== 'undefined'));
                
                const canvas = document.getElementById('qr-canvas');
                log('debug-single', 'Canvas found: ' + !!canvas);

                log('debug-single', 'Generating QR code...');
                
                await QRCode.toCanvas(canvas, fullUrl, {
                    width: 200,
                    margin: 2,
                    color: { dark: '#0f172a', light: '#ffffff' }
                });

                log('debug-single', 'QR code generated successfully!');

                document.getElementById('qr-asset-label').textContent = assetId;
                document.getElementById('qr-full-url').textContent = 'URL: ' + fullUrl.substring(0, 80) + '...';
                document.getElementById('single-output').classList.add('active');

                currentQR = { assetId, fullUrl, canvas };
                log('debug-single', 'Done!');

            } catch (err) {
                log('debug-single', 'ERROR: ' + err.message);
                log('debug-single', 'Stack: ' + err.stack);
                alert('Error: ' + err.message);
            }
        }

        function downloadSingleQR() {
            if (!currentQR) return;
            
            const canvas = currentQR.canvas;
            const newCanvas = document.createElement('canvas');
            const ctx = newCanvas.getContext('2d');
            
            newCanvas.width = canvas.width + 40;
            newCanvas.height = canvas.height + 60;
            
            ctx.fillStyle = '#fff';
            ctx.fillRect(0, 0, newCanvas.width, newCanvas.height);
            ctx.drawImage(canvas, 20, 20);
            
            ctx.fillStyle = '#000';
            ctx.font = 'bold 14px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(currentQR.assetId, newCanvas.width / 2, canvas.height + 45);

            const link = document.createElement('a');
            link.download = 'QR-' + currentQR.assetId + '.png';
            link.href = newCanvas.toDataURL('image/png');
            link.click();
        }

        function importExcel(event) {
            const file = event.target.files[0];
            if (!file) return;

            clearLog('debug-batch');
            log('debug-batch', 'Importing: ' + file.name);

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

                    log('debug-batch', 'Rows found: ' + rows.length);

                    const lines = [];
                    for (let i = 1; i < rows.length; i++) {
                        if (rows[i][0] && rows[i][1]) {
                            lines.push(rows[i][0] + ', ' + rows[i][1]);
                        }
                    }

                    document.getElementById('batch-data').value = lines.join('\n');
                    log('debug-batch', 'Imported ' + lines.length + ' rows');
                    alert('Imported ' + lines.length + ' assets!');

                } catch (err) {
                    log('debug-batch', 'Error: ' + err.message);
                    alert('Error reading file: ' + err.message);
                }
            };
            reader.readAsArrayBuffer(file);
            event.target.value = '';
        }

        function downloadTemplate() {
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet([
                ['Asset ID', 'Tandem URL'],
                ['CAM.E1879-A.01', 'https://tandem.autodesk.com/pages/facilities/...'],
                ['HVAC.B2201-C.05', 'https://tandem.autodesk.com/pages/facilities/...']
            ]);
            ws['!cols'] = [{ wch: 20 }, { wch: 60 }];
            XLSX.utils.book_append_sheet(wb, ws, 'Assets');
            XLSX.writeFile(wb, 'QR-Template.xlsx');
        }

        async function generateBatchQR() {
            clearLog('debug-batch');
            log('debug-batch', '=== Starting Batch Generation ===');

            const text = document.getElementById('batch-data').value.trim();
            if (!text) {
                alert('Please enter data or import Excel');
                return;
            }

            log('debug-batch', 'Text length: ' + text.length);

            let lines = text.split('\n').filter(l => l.trim());
            log('debug-batch', 'Total lines: ' + lines.length);
            
            // Skip header row if present
            if (lines.length > 0) {
                const firstLine = lines[0].toLowerCase();
                if (firstLine.includes('asset') && firstLine.includes('url')) {
                    log('debug-batch', 'Skipping header row: ' + lines[0]);
                    lines = lines.slice(1);
                }
            }
            
            log('debug-batch', 'Data lines to process: ' + lines.length);

            batchQRs = [];
            const container = document.getElementById('batch-results');
            container.innerHTML = '';

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                log('debug-batch', '--- Processing line ' + (i+1) + ' ---');

                // Split by comma or tab
                let parts = line.includes('\t') ? line.split('\t') : line.split(',');
                parts = parts.map(p => p.trim());
                
                log('debug-batch', 'Parts found: ' + parts.length);
                log('debug-batch', 'Asset: ' + (parts[0] || 'EMPTY'));

                if (parts.length < 2 || !parts[0] || !parts[1]) {
                    log('debug-batch', 'SKIP: missing asset or URL');
                    continue;
                }

                const assetId = parts[0];
                const tandemUrl = parts.slice(1).join(',').trim();
                const fullUrl = buildUrl(assetId, tandemUrl);
                
                log('debug-batch', 'Full URL length: ' + fullUrl.length);

                try {
                    const div = document.createElement('div');
                    div.className = 'batch-item';

                    const canvas = document.createElement('canvas');
                    
                    await QRCode.toCanvas(canvas, fullUrl, {
                        width: 150,
                        margin: 2,
                        color: { dark: '#0f172a', light: '#ffffff' }
                    });
                    
                    log('debug-batch', 'QR generated OK');

                    const label = document.createElement('div');
                    label.className = 'batch-item-label';
                    label.textContent = assetId;

                    const btn = document.createElement('button');
                    btn.className = 'batch-item-download';
                    btn.textContent = 'Download';
                    btn.onclick = () => downloadOne(assetId, canvas);

                    div.appendChild(canvas);
                    div.appendChild(label);
                    div.appendChild(btn);
                    container.appendChild(div);

                    batchQRs.push({ assetId, canvas });

                } catch (err) {
                    log('debug-batch', 'ERROR: ' + err.message);
                    console.error('QR Error for ' + assetId, err);
                }
            }

            log('debug-batch', '=== Complete ===');
            log('debug-batch', 'Generated: ' + batchQRs.length + ' QR codes');

            if (batchQRs.length > 0) {
                document.getElementById('batch-output').classList.add('active');
            } else {
                alert('No QR codes could be generated. Please check your data format.\n\nExpected format:\nAssetID, TandemURL');
            }
        }

        function downloadOne(assetId, canvas) {
            const newCanvas = document.createElement('canvas');
            const ctx = newCanvas.getContext('2d');
            newCanvas.width = canvas.width + 30;
            newCanvas.height = canvas.height + 50;
            ctx.fillStyle = '#fff';
            ctx.fillRect(0, 0, newCanvas.width, newCanvas.height);
            ctx.drawImage(canvas, 15, 15);
            ctx.fillStyle = '#000';
            ctx.font = 'bold 12px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(assetId, newCanvas.width / 2, canvas.height + 35);

            const link = document.createElement('a');
            link.download = 'QR-' + assetId + '.png';
            link.href = newCanvas.toDataURL('image/png');
            link.click();
        }

        async function downloadAllZip() {
            if (!batchQRs.length) return;

            const zip = new JSZip();

            for (const item of batchQRs) {
                const newCanvas = document.createElement('canvas');
                const ctx = newCanvas.getContext('2d');
                newCanvas.width = item.canvas.width + 30;
                newCanvas.height = item.canvas.height + 50;
                ctx.fillStyle = '#fff';
                ctx.fillRect(0, 0, newCanvas.width, newCanvas.height);
                ctx.drawImage(item.canvas, 15, 15);
                ctx.fillStyle = '#000';
                ctx.font = 'bold 12px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(item.assetId, newCanvas.width / 2, item.canvas.height + 35);

                const dataUrl = newCanvas.toDataURL('image/png');
                zip.file('QR-' + item.assetId + '.png', dataUrl.split(',')[1], { base64: true });
            }

            const blob = await zip.generateAsync({ type: 'blob' });
            const link = document.createElement('a');
            link.download = 'QR-Codes.zip';
            link.href = URL.createObjectURL(blob);
            link.click();
        }

        // Check libraries on load
        window.onload = function() {
            console.log('QRCode:', typeof QRCode);
            console.log('XLSX:', typeof XLSX);
            console.log('JSZip:', typeof JSZip);
        };
    </script>
</body>
</html>
