<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ABC Healthcare QR Code Generator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=Instrument+Serif:ital@0;1&display=swap" rel="stylesheet">
    <style>
        :root {
            --slate-900: #0f172a;
            --slate-800: #1e293b;
            --slate-700: #334155;
            --slate-600: #475569;
            --slate-400: #94a3b8;
            --slate-200: #e2e8f0;
            --slate-100: #f1f5f9;
            --slate-50: #f8fafc;
            --teal-600: #0d9488;
            --teal-500: #14b8a6;
            --teal-400: #2dd4bf;
            --white: #ffffff;
            --shadow-strong: 0 16px 48px -12px rgba(15, 23, 42, 0.25);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'DM Sans', sans-serif; background: var(--slate-100); min-height: 100vh; color: var(--slate-800); }
        .header { background: linear-gradient(135deg, var(--slate-900) 0%, var(--slate-700) 100%); padding: 2.5rem 2rem 3.5rem; text-align: center; }
        .logo-badge { display: inline-flex; align-items: center; background: rgba(255,255,255,0.1); padding: 0.5rem 1rem; border-radius: 50px; margin-bottom: 1.25rem; }
        .logo-badge span { font-size: 0.75rem; font-weight: 600; letter-spacing: 0.1em; text-transform: uppercase; color: var(--teal-400); }
        h1 { font-family: 'Instrument Serif', serif; font-size: 2.5rem; font-weight: 400; color: white; margin-bottom: 0.5rem; }
        .subtitle { font-size: 1rem; color: var(--slate-400); }
        .main-content { max-width: 1000px; margin: -2rem auto 3rem; padding: 0 1.5rem; }
        .card { background: white; border-radius: 20px; box-shadow: var(--shadow-strong); padding: 2rem; }
        .tabs { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; }
        .tab { padding: 0.625rem 1.25rem; border: 1px solid var(--slate-200); border-radius: 8px; background: white; cursor: pointer; font-family: inherit; font-size: 0.875rem; }
        .tab.active { background: var(--slate-800); color: white; border-color: var(--slate-800); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .form-group { margin-bottom: 1.25rem; }
        .form-label { display: block; font-size: 0.8rem; font-weight: 600; text-transform: uppercase; color: var(--slate-500); margin-bottom: 0.5rem; }
        .form-input, .batch-textarea { width: 100%; padding: 0.875rem 1rem; border: 1px solid var(--slate-200); border-radius: 10px; font-family: inherit; font-size: 0.95rem; }
        .batch-textarea { min-height: 150px; font-family: monospace; font-size: 0.85rem; }
        .generate-btn { display: block; width: 100%; padding: 1rem; border: none; border-radius: 12px; background: linear-gradient(135deg, var(--teal-600), var(--teal-500)); color: white; font-family: inherit; font-size: 1rem; font-weight: 600; cursor: pointer; }
        .generate-btn:hover { opacity: 0.9; }
        .import-section { display: flex; gap: 0.75rem; margin-bottom: 1.25rem; flex-wrap: wrap; }
        .import-btn, .template-btn { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1.25rem; border-radius: 10px; font-family: inherit; font-size: 0.9rem; cursor: pointer; }
        .import-btn { border: 2px dashed var(--teal-400); background: rgba(20,184,166,0.05); color: var(--teal-600); font-weight: 600; }
        .template-btn { border: 1px solid var(--slate-200); background: white; color: var(--slate-600); }
        .output-section { display: none; margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--slate-200); }
        .output-section.active { display: block; }
        .qr-preview { background: white; border: 1px solid var(--slate-200); border-radius: 16px; padding: 1.5rem; text-align: center; display: inline-block; }
        .qr-asset-label { margin-top: 1rem; font-size: 1.1rem; font-weight: 700; }
        .batch-results { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 1rem; margin-top: 1rem; }
        .batch-item { background: white; border: 1px solid var(--slate-200); border-radius: 12px; padding: 1rem; text-align: center; }
        .batch-item canvas, .batch-item img { display: block; margin: 0 auto; }
        .batch-item-label { margin-top: 0.75rem; font-size: 0.85rem; font-weight: 600; }
        .batch-item-download { margin-top: 0.5rem; padding: 0.5rem 0.75rem; border: none; border-radius: 6px; background: var(--slate-100); cursor: pointer; font-size: 0.75rem; }
        .download-btn { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1.25rem; border: none; border-radius: 10px; background: var(--slate-800); color: white; font-family: inherit; cursor: pointer; margin-bottom: 1rem; }
        .footer { text-align: center; padding: 2rem; color: var(--slate-400); font-size: 0.8rem; }
        .footer a { color: var(--slate-400); text-decoration: none; }
        .debug-box { background: #111; color: #0f0; padding: 1rem; border-radius: 8px; font-family: monospace; font-size: 0.7rem; margin-top: 1rem; max-height: 200px; overflow-y: auto; white-space: pre-wrap; }
        .status-bar { background: var(--slate-50); border: 1px solid var(--slate-200); border-radius: 8px; padding: 0.75rem 1rem; margin-bottom: 1rem; font-size: 0.8rem; color: var(--slate-600); }
        .status-bar.success { background: #dcfce7; border-color: #86efac; color: #166534; }
        .status-bar.error { background: #fef2f2; border-color: #fecaca; color: #dc2626; }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo-badge"><span>üîß Admin Tools</span></div>
        <h1>QR Code Generator</h1>
        <p class="subtitle">Generate asset QR codes for the Help Center portal</p>
    </header>

    <main class="main-content">
        <div class="card">
            <div id="status-bar" class="status-bar">Initializing...</div>
            
            <div class="tabs">
                <button class="tab active" onclick="switchTab('single')">Single QR Code</button>
                <button class="tab" onclick="switchTab('batch')">Batch Generate</button>
            </div>

            <!-- Single Tab -->
            <div id="single-tab" class="tab-content active">
                <div class="form-group">
                    <label class="form-label">Asset ID</label>
                    <input type="text" id="asset-id" class="form-input" placeholder="e.g., CAM.E1879-A.01">
                </div>
                <div class="form-group">
                    <label class="form-label">Tandem URL</label>
                    <input type="text" id="tandem-url" class="form-input" placeholder="https://tandem.autodesk.com/...">
                </div>
                <button class="generate-btn" onclick="generateSingleQR()">Generate QR Code</button>
                <div id="single-output" class="output-section">
                    <div class="qr-preview">
                        <div id="qr-container"></div>
                        <div class="qr-asset-label" id="qr-asset-label"></div>
                    </div>
                    <p style="margin-top:1rem; color: var(--slate-500); word-break: break-all; font-size: 0.8rem;" id="qr-full-url"></p>
                    <button class="download-btn" onclick="downloadSingleQR()">Download PNG</button>
                </div>
                <div id="debug-single" class="debug-box" style="display:none;"></div>
            </div>

            <!-- Batch Tab -->
            <div id="batch-tab" class="tab-content">
                <div class="import-section">
                    <button class="import-btn" onclick="document.getElementById('excel-file').click()">üìä Import Excel</button>
                    <input type="file" id="excel-file" accept=".xlsx,.xls" style="display:none" onchange="importExcel(event)">
                    <button class="template-btn" onclick="downloadTemplate()">‚¨áÔ∏è Download Template</button>
                </div>
                <div class="form-group">
                    <label class="form-label">Asset Data (one per line: AssetID, URL)</label>
                    <textarea id="batch-data" class="batch-textarea" placeholder="CAM.E1879-A.01, https://tandem.autodesk.com/..."></textarea>
                </div>
                <button class="generate-btn" onclick="generateBatchQR()">Generate All QR Codes</button>
                <div id="batch-output" class="output-section">
                    <button class="download-btn" onclick="downloadAllZip()">Download All (ZIP)</button>
                    <div id="batch-results" class="batch-results"></div>
                </div>
                <div id="debug-batch" class="debug-box" style="display:none;"></div>
            </div>
        </div>
    </main>

    <footer class="footer">
        ¬© 2025 ABC Healthcare ¬∑ QR Code Generator
        <br><a href="index.html">‚Üê Back to Help Center Portal</a>
    </footer>

    <!-- Excel library -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- JSZip for batch download -->
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

    <!-- EMBEDDED: qrcode-generator library by Kazuhiko Arase (MIT License) -->
    <!-- This is the full, working qrcode-generator library -->
    <script>
var qrcode=function(){var qrcode=function(typeNumber,errorCorrectionLevel){var PAD0=0xEC;var PAD1=0x11;var _typeNumber=typeNumber;var _errorCorrectionLevel=QRErrorCorrectionLevel[errorCorrectionLevel];var _modules=null;var _moduleCount=0;var _dataCache=null;var _dataList=[];var _this={};var makeImpl=function(test,maskPattern){_moduleCount=_typeNumber*4+17;_modules=function(moduleCount){var modules=[];for(var row=0;row<moduleCount;row+=1){modules[row]=[];for(var col=0;col<moduleCount;col+=1){modules[row][col]=null}}return modules}(_moduleCount);setupPositionProbePattern(0,0);setupPositionProbePattern(_moduleCount-7,0);setupPositionProbePattern(0,_moduleCount-7);setupPositionAdjustPattern();setupTimingPattern();setupTypeInfo(test,maskPattern);if(_typeNumber>=7){setupTypeNumber(test)}if(_dataCache==null){_dataCache=createData(_typeNumber,_errorCorrectionLevel,_dataList)}mapData(_dataCache,maskPattern)};var setupPositionProbePattern=function(row,col){for(var r=-1;r<=7;r+=1){if(row+r<=-1||_moduleCount<=row+r)continue;for(var c=-1;c<=7;c+=1){if(col+c<=-1||_moduleCount<=col+c)continue;if((0<=r&&r<=6&&(c==0||c==6))||(0<=c&&c<=6&&(r==0||r==6))||(2<=r&&r<=4&&2<=c&&c<=4)){_modules[row+r][col+c]=true}else{_modules[row+r][col+c]=false}}}};var getBestMaskPattern=function(){var minLostPoint=0;var pattern=0;for(var i=0;i<8;i+=1){makeImpl(true,i);var lostPoint=QRUtil.getLostPoint(_this);if(i==0||minLostPoint>lostPoint){minLostPoint=lostPoint;pattern=i}}return pattern};var setupTimingPattern=function(){for(var r=8;r<_moduleCount-8;r+=1){if(_modules[r][6]!=null){continue}_modules[r][6]=(r%2==0)}for(var c=8;c<_moduleCount-8;c+=1){if(_modules[6][c]!=null){continue}_modules[6][c]=(c%2==0)}};var setupPositionAdjustPattern=function(){var pos=QRUtil.getPatternPosition(_typeNumber);for(var i=0;i<pos.length;i+=1){for(var j=0;j<pos.length;j+=1){var row=pos[i];var col=pos[j];if(_modules[row][col]!=null){continue}for(var r=-2;r<=2;r+=1){for(var c=-2;c<=2;c+=1){if(r==-2||r==2||c==-2||c==2||(r==0&&c==0)){_modules[row+r][col+c]=true}else{_modules[row+r][col+c]=false}}}}}};var setupTypeNumber=function(test){var bits=QRUtil.getBCHTypeNumber(_typeNumber);for(var i=0;i<18;i+=1){var mod=(!test&&((bits>>i)&1)==1);_modules[Math.floor(i/3)][i%3+_moduleCount-8-3]=mod}for(var i=0;i<18;i+=1){var mod=(!test&&((bits>>i)&1)==1);_modules[i%3+_moduleCount-8-3][Math.floor(i/3)]=mod}};var setupTypeInfo=function(test,maskPattern){var data=(_errorCorrectionLevel<<3)|maskPattern;var bits=QRUtil.getBCHTypeInfo(data);for(var i=0;i<15;i+=1){var mod=(!test&&((bits>>i)&1)==1);if(i<6){_modules[i][8]=mod}else if(i<8){_modules[i+1][8]=mod}else{_modules[_moduleCount-15+i][8]=mod}}for(var i=0;i<15;i+=1){var mod=(!test&&((bits>>i)&1)==1);if(i<8){_modules[8][_moduleCount-i-1]=mod}else if(i<9){_modules[8][15-i-1+1]=mod}else{_modules[8][15-i-1]=mod}}_modules[_moduleCount-8][8]=(!test)};var mapData=function(data,maskPattern){var inc=-1;var row=_moduleCount-1;var bitIndex=7;var byteIndex=0;var maskFunc=QRUtil.getMaskFunction(maskPattern);for(var col=_moduleCount-1;col>0;col-=2){if(col==6)col-=1;while(true){for(var c=0;c<2;c+=1){if(_modules[row][col-c]==null){var dark=false;if(byteIndex<data.length){dark=(((data[byteIndex]>>>bitIndex)&1)==1)}if(maskFunc(row,col-c)){dark=!dark}_modules[row][col-c]=dark;bitIndex-=1;if(bitIndex==-1){byteIndex+=1;bitIndex=7}}}row+=inc;if(row<0||_moduleCount<=row){row-=inc;inc=-inc;break}}}};var createBytes=function(buffer,rsBlocks){var offset=0;var maxDcCount=0;var maxEcCount=0;var dcdata=[];var ecdata=[];for(var r=0;r<rsBlocks.length;r+=1){dcdata[r]=[];ecdata[r]=[]}for(var r=0;r<rsBlocks.length;r+=1){var dcCount=rsBlocks[r].dataCount;var ecCount=rsBlocks[r].totalCount-dcCount;maxDcCount=Math.max(maxDcCount,dcCount);maxEcCount=Math.max(maxEcCount,ecCount);dcdata[r]=[];for(var i=0;i<dcCount;i+=1){dcdata[r][i]=0xff&buffer.getBuffer()[i+offset]}offset+=dcCount;var rsPoly=QRUtil.getErrorCorrectPolynomial(ecCount);var rawPoly=qrPolynomial(dcdata[r],rsPoly.getLength()-1);var modPoly=rawPoly.mod(rsPoly);ecdata[r]=[];for(var i=0;i<rsPoly.getLength()-1;i+=1){var modIndex=i+modPoly.getLength()-rsPoly.getLength()+1;ecdata[r][i]=(modIndex>=0)?modPoly.getAt(modIndex):0}}var totalCodeCount=0;for(var i=0;i<rsBlocks.length;i+=1){totalCodeCount+=rsBlocks[i].totalCount}var data=[];var index=0;for(var i=0;i<maxDcCount;i+=1){for(var r=0;r<rsBlocks.length;r+=1){if(i<dcdata[r].length){data[index]=dcdata[r][i];index+=1}}}for(var i=0;i<maxEcCount;i+=1){for(var r=0;r<rsBlocks.length;r+=1){if(i<ecdata[r].length){data[index]=ecdata[r][i];index+=1}}}return data};var createData=function(typeNumber,errorCorrectionLevel,dataList){var rsBlocks=QRRSBlock.getRSBlocks(typeNumber,errorCorrectionLevel);var buffer=qrBitBuffer();for(var i=0;i<dataList.length;i+=1){var data=dataList[i];buffer.put(data.getMode(),4);buffer.put(data.getLength(),QRUtil.getLengthInBits(data.getMode(),typeNumber));data.write(buffer)}var totalDataCount=0;for(var i=0;i<rsBlocks.length;i+=1){totalDataCount+=rsBlocks[i].dataCount}if(buffer.getLengthInBits()>totalDataCount*8){throw'code length overflow. ('+buffer.getLengthInBits()+'>'+totalDataCount*8+')'}if(buffer.getLengthInBits()+4<=totalDataCount*8){buffer.put(0,4)}while(buffer.getLengthInBits()%8!=0){buffer.putBit(false)}while(true){if(buffer.getLengthInBits()>=totalDataCount*8){break}buffer.put(PAD0,8);if(buffer.getLengthInBits()>=totalDataCount*8){break}buffer.put(PAD1,8)}return createBytes(buffer,rsBlocks)};_this.addData=function(data,mode){mode=mode||'Byte';var newData=null;switch(mode){case'Numeric':newData=qrNumber(data);break;case'Alphanumeric':newData=qrAlphaNum(data);break;case'Byte':newData=qr8BitByte(data);break;case'Kanji':newData=qrKanji(data);break;default:throw'mode:'+mode}_dataList.push(newData);_dataCache=null};_this.isDark=function(row,col){if(row<0||_moduleCount<=row||col<0||_moduleCount<=col){throw row+','+col}return _modules[row][col]};_this.getModuleCount=function(){return _moduleCount};_this.make=function(){if(_typeNumber<1){var typeNumber=1;for(;typeNumber<40;typeNumber++){var rsBlocks=QRRSBlock.getRSBlocks(typeNumber,_errorCorrectionLevel);var buffer=qrBitBuffer();for(var i=0;i<_dataList.length;i+=1){var data=_dataList[i];buffer.put(data.getMode(),4);buffer.put(data.getLength(),QRUtil.getLengthInBits(data.getMode(),typeNumber));data.write(buffer)}var totalDataCount=0;for(var i=0;i<rsBlocks.length;i+=1){totalDataCount+=rsBlocks[i].dataCount}if(buffer.getLengthInBits()<=totalDataCount*8){break}}_typeNumber=typeNumber}makeImpl(false,getBestMaskPattern())};_this.createTableTag=function(cellSize,margin){cellSize=cellSize||2;margin=(typeof margin=='undefined')?cellSize*4:margin;var qrHtml='';qrHtml+='<table style="';qrHtml+=' border-width: 0px; border-style: none;';qrHtml+=' border-collapse: collapse;';qrHtml+=' padding: 0px; margin: '+margin+'px;';qrHtml+='">';qrHtml+='<tbody>';for(var r=0;r<_this.getModuleCount();r+=1){qrHtml+='<tr>';for(var c=0;c<_this.getModuleCount();c+=1){qrHtml+='<td style="';qrHtml+=' border-width: 0px; border-style: none;';qrHtml+=' border-collapse: collapse;';qrHtml+=' padding: 0px; margin: 0px;';qrHtml+=' width: '+cellSize+'px;';qrHtml+=' height: '+cellSize+'px;';qrHtml+=' background-color: ';qrHtml+=(_this.isDark(r,c)?'#000000':'#ffffff');qrHtml+=';';qrHtml+='"/>'} qrHtml+='</tr>'}qrHtml+='</tbody>';qrHtml+='</table>';return qrHtml};_this.createSvgTag=function(cellSize,margin){cellSize=cellSize||2;margin=(typeof margin=='undefined')?cellSize*4:margin;var size=_this.getModuleCount()*cellSize+margin*2;var qrSvg='';qrSvg+='<svg version="1.1" xmlns="http://www.w3.org/2000/svg"';qrSvg+=' width="'+size+'px"';qrSvg+=' height="'+size+'px"';qrSvg+=' viewBox="0 0 '+size+' '+size+'" ';qrSvg+=' preserveAspectRatio="xMinYMin meet">';qrSvg+='<rect width="100%" height="100%" fill="white" cx="0" cy="0"/>';qrSvg+='<path d="';for(var r=0;r<_this.getModuleCount();r+=1){var mr=r*cellSize+margin;for(var c=0;c<_this.getModuleCount();c+=1){if(_this.isDark(r,c)){var mc=c*cellSize+margin;qrSvg+='M'+mc+','+mr+'l'+cellSize+',0l0,'+cellSize+'l-'+cellSize+',0l0,-'+cellSize+'z'}}}qrSvg+='" stroke="transparent" fill="black"/>';qrSvg+='</svg>';return qrSvg};_this.createDataURL=function(cellSize,margin){cellSize=cellSize||2;margin=(typeof margin=='undefined')?cellSize*4:margin;var size=_this.getModuleCount()*cellSize+margin*2;var min=margin;var max=size-margin;return createDataURL(size,size,function(x,y){if(min<=x&&x<max&&min<=y&&y<max){var c=Math.floor((x-min)/cellSize);var r=Math.floor((y-min)/cellSize);return _this.isDark(r,c)?0:1}else{return 1}})};_this.createImgTag=function(cellSize,margin,alt){cellSize=cellSize||2;margin=(typeof margin=='undefined')?cellSize*4:margin;var size=_this.getModuleCount()*cellSize+margin*2;var img='';img+='<img';img+=' src="';img+=_this.createDataURL(cellSize,margin);img+='"';img+=' width="';img+=size;img+='"';img+=' height="';img+=size;img+='"';if(alt){img+=' alt="';img+=alt;img+='"'}img+='/>';return img};var createDataURL=function(width,height,getPixel){var gif=gifImage(width,height);for(var y=0;y<height;y+=1){for(var x=0;x<width;x+=1){gif.setPixel(x,y,getPixel(x,y))}}return gif.toDataURL()};return _this};qrcode.stringToBytes=(function(){return function(s){var bytes=[];for(var i=0;i<s.length;i+=1){var c=s.charCodeAt(i);bytes.push(c&0xff)}return bytes}})();qrcode.createStringToBytes=function(unicodeData,numChars){var unicodeMap=function(){var bin=atob(unicodeData);var helper=function(c){return'0123456789ABCDEF'.charAt(c)};var s='';for(var i=0;i<bin.length;i+=1){var c=bin.charCodeAt(i);s+=helper(c>>4);s+=helper(c&0xf)}return s}();var unknownChar='?'.charCodeAt(0);return function(s){var bytes=[];for(var i=0;i<s.length;i+=1){var c=s.charCodeAt(i);if(c<128){bytes.push(c)}else{var b=unknownChar;for(var j=0;j<numChars;j+=1){var k=parseInt(unicodeMap.substring((c-128)*numChars*2+j*2,(c-128)*numChars*2+j*2+2),16);if(k!=0){b=k;break}}bytes.push(b)}}return bytes}};var QRMode={MODE_NUMBER:1<<0,MODE_ALPHA_NUM:1<<1,MODE_8BIT_BYTE:1<<2,MODE_KANJI:1<<3};var QRErrorCorrectionLevel={L:1,M:0,Q:3,H:2};var QRMaskPattern={PATTERN000:0,PATTERN001:1,PATTERN010:2,PATTERN011:3,PATTERN100:4,PATTERN101:5,PATTERN110:6,PATTERN111:7};var QRUtil=function(){var PATTERN_POSITION_TABLE=[[],[6,18],[6,22],[6,26],[6,30],[6,34],[6,22,38],[6,24,42],[6,26,46],[6,28,50],[6,30,54],[6,32,58],[6,34,62],[6,26,46,66],[6,26,48,70],[6,26,50,74],[6,30,54,78],[6,30,56,82],[6,30,58,86],[6,34,62,90],[6,28,50,72,94],[6,26,50,74,98],[6,30,54,78,102],[6,28,54,80,106],[6,32,58,84,110],[6,30,58,86,114],[6,34,62,90,118],[6,26,50,74,98,122],[6,30,54,78,102,126],[6,26,52,78,104,130],[6,30,56,82,108,134],[6,34,60,86,112,138],[6,30,58,86,114,142],[6,34,62,90,118,146],[6,30,54,78,102,126,150],[6,24,50,76,102,128,154],[6,28,54,80,106,132,158],[6,32,58,84,110,136,162],[6,26,54,82,110,138,166],[6,30,58,86,114,142,170]];var G15=(1<<10)|(1<<8)|(1<<5)|(1<<4)|(1<<2)|(1<<1)|(1<<0);var G18=(1<<12)|(1<<11)|(1<<10)|(1<<9)|(1<<8)|(1<<5)|(1<<2)|(1<<0);var G15_MASK=(1<<14)|(1<<12)|(1<<10)|(1<<4)|(1<<1);var _this={};var getBCHDigit=function(data){var digit=0;while(data!=0){digit+=1;data>>>=1}return digit};_this.getBCHTypeInfo=function(data){var d=data<<10;while(getBCHDigit(d)-getBCHDigit(G15)>=0){d^=(G15<<(getBCHDigit(d)-getBCHDigit(G15)))}return((data<<10)|d)^G15_MASK};_this.getBCHTypeNumber=function(data){var d=data<<12;while(getBCHDigit(d)-getBCHDigit(G18)>=0){d^=(G18<<(getBCHDigit(d)-getBCHDigit(G18)))}return(data<<12)|d};_this.getPatternPosition=function(typeNumber){return PATTERN_POSITION_TABLE[typeNumber-1]};_this.getMaskFunction=function(maskPattern){switch(maskPattern){case QRMaskPattern.PATTERN000:return function(i,j){return(i+j)%2==0};case QRMaskPattern.PATTERN001:return function(i,j){return i%2==0};case QRMaskPattern.PATTERN010:return function(i,j){return j%3==0};case QRMaskPattern.PATTERN011:return function(i,j){return(i+j)%3==0};case QRMaskPattern.PATTERN100:return function(i,j){return(Math.floor(i/2)+Math.floor(j/3))%2==0};case QRMaskPattern.PATTERN101:return function(i,j){return(i*j)%2+(i*j)%3==0};case QRMaskPattern.PATTERN110:return function(i,j){return((i*j)%2+(i*j)%3)%2==0};case QRMaskPattern.PATTERN111:return function(i,j){return((i*j)%3+(i+j)%2)%2==0};default:throw'bad maskPattern:'+maskPattern}};_this.getErrorCorrectPolynomial=function(errorCorrectLength){var a=qrPolynomial([1],0);for(var i=0;i<errorCorrectLength;i+=1){a=a.multiply(qrPolynomial([1,QRMath.gexp(i)],0))}return a};_this.getLengthInBits=function(mode,type){if(1<=type&&type<10){switch(mode){case QRMode.MODE_NUMBER:return 10;case QRMode.MODE_ALPHA_NUM:return 9;case QRMode.MODE_8BIT_BYTE:return 8;case QRMode.MODE_KANJI:return 8;default:throw'mode:'+mode}}else if(type<27){switch(mode){case QRMode.MODE_NUMBER:return 12;case QRMode.MODE_ALPHA_NUM:return 11;case QRMode.MODE_8BIT_BYTE:return 16;case QRMode.MODE_KANJI:return 10;default:throw'mode:'+mode}}else if(type<41){switch(mode){case QRMode.MODE_NUMBER:return 14;case QRMode.MODE_ALPHA_NUM:return 13;case QRMode.MODE_8BIT_BYTE:return 16;case QRMode.MODE_KANJI:return 12;default:throw'mode:'+mode}}else{throw'type:'+type}};_this.getLostPoint=function(qrcode){var moduleCount=qrcode.getModuleCount();var lostPoint=0;for(var row=0;row<moduleCount;row+=1){for(var col=0;col<moduleCount;col+=1){var sameCount=0;var dark=qrcode.isDark(row,col);for(var r=-1;r<=1;r+=1){if(row+r<0||moduleCount<=row+r){continue}for(var c=-1;c<=1;c+=1){if(col+c<0||moduleCount<=col+c){continue}if(r==0&&c==0){continue}if(dark==qrcode.isDark(row+r,col+c)){sameCount+=1}}}if(sameCount>5){lostPoint+=(3+sameCount-5)}}}for(var row=0;row<moduleCount-1;row+=1){for(var col=0;col<moduleCount-1;col+=1){var count=0;if(qrcode.isDark(row,col))count+=1;if(qrcode.isDark(row+1,col))count+=1;if(qrcode.isDark(row,col+1))count+=1;if(qrcode.isDark(row+1,col+1))count+=1;if(count==0||count==4){lostPoint+=3}}}for(var row=0;row<moduleCount;row+=1){for(var col=0;col<moduleCount-6;col+=1){if(qrcode.isDark(row,col)&&!qrcode.isDark(row,col+1)&&qrcode.isDark(row,col+2)&&qrcode.isDark(row,col+3)&&qrcode.isDark(row,col+4)&&!qrcode.isDark(row,col+5)&&qrcode.isDark(row,col+6)){lostPoint+=40}}}for(var col=0;col<moduleCount;col+=1){for(var row=0;row<moduleCount-6;row+=1){if(qrcode.isDark(row,col)&&!qrcode.isDark(row+1,col)&&qrcode.isDark(row+2,col)&&qrcode.isDark(row+3,col)&&qrcode.isDark(row+4,col)&&!qrcode.isDark(row+5,col)&&qrcode.isDark(row+6,col)){lostPoint+=40}}}var darkCount=0;for(var col=0;col<moduleCount;col+=1){for(var row=0;row<moduleCount;row+=1){if(qrcode.isDark(row,col)){darkCount+=1}}}var ratio=Math.abs(100*darkCount/moduleCount/moduleCount-50)/5;lostPoint+=ratio*10;return lostPoint};return _this}();var QRMath=function(){var EXP_TABLE=[];var LOG_TABLE=[];for(var i=0;i<256;i+=1){EXP_TABLE[i]=(i<8)?1<<i:EXP_TABLE[i-4]^EXP_TABLE[i-5]^EXP_TABLE[i-6]^EXP_TABLE[i-8]}for(var i=0;i<255;i+=1){LOG_TABLE[EXP_TABLE[i]]=i}var _this={};_this.glog=function(n){if(n<1){throw'glog('+n+')'}return LOG_TABLE[n]};_this.gexp=function(n){while(n<0){n+=255}while(n>=256){n-=255}return EXP_TABLE[n]};return _this}();var qrPolynomial=function(num,shift){if(typeof num.length=='undefined'){throw num.length+'/'+shift}var _num=function(){var offset=0;while(offset<num.length&&num[offset]==0){offset+=1}var _num=[];for(var i=0;i<num.length-offset;i+=1){_num[i]=num[i+offset]}return _num}();var _this={};_this.getAt=function(index){return _num[index]};_this.getLength=function(){return _num.length};_this.multiply=function(e){var num=[];for(var i=0;i<_this.getLength()+e.getLength()-1;i+=1){num[i]=0}for(var i=0;i<_this.getLength();i+=1){for(var j=0;j<e.getLength();j+=1){num[i+j]^=QRMath.gexp(QRMath.glog(_this.getAt(i))+QRMath.glog(e.getAt(j)))}}return qrPolynomial(num,0)};_this.mod=function(e){if(_this.getLength()-e.getLength()<0){return _this}var ratio=QRMath.glog(_this.getAt(0))-QRMath.glog(e.getAt(0));var num=[];for(var i=0;i<_this.getLength();i+=1){num[i]=_this.getAt(i)}for(var i=0;i<e.getLength();i+=1){num[i]^=QRMath.gexp(QRMath.glog(e.getAt(i))+ratio)}return qrPolynomial(num,0).mod(e)};return _this};var QRRSBlock=function(){var RS_BLOCK_TABLE=[[1,26,19],[1,26,16],[1,26,13],[1,26,9],[1,44,34],[1,44,28],[1,44,22],[1,44,16],[1,70,55],[1,70,44],[2,35,17],[2,35,13],[1,100,80],[2,50,32],[2,50,24],[4,25,9],[1,134,108],[2,67,43],[2,33,15,2,34,16],[2,33,11,2,34,12],[2,86,68],[4,43,27],[4,43,19],[4,43,15],[2,98,78],[4,49,31],[2,32,14,4,33,15],[4,39,13,1,40,14],[2,121,97],[2,60,38,2,61,39],[4,40,18,2,41,19],[4,40,14,2,41,15],[2,146,116],[3,58,36,2,59,37],[4,36,16,4,37,17],[4,36,12,4,37,13],[2,86,68,2,87,69],[4,69,43,1,70,44],[6,43,19,2,44,20],[6,43,15,2,44,16],[4,101,81],[1,80,50,4,81,51],[4,50,22,4,51,23],[3,36,12,8,37,13],[2,116,92,2,117,93],[6,58,36,2,59,37],[4,46,20,6,47,21],[7,42,14,4,43,15],[4,133,107],[8,59,37,1,60,38],[8,44,20,4,45,21],[12,33,11,4,34,12],[3,145,115,1,146,116],[4,64,40,5,65,41],[11,36,16,5,37,17],[11,36,12,5,37,13],[5,109,87,1,110,88],[5,65,41,5,66,42],[5,54,24,7,55,25],[11,36,12,7,37,13],[5,122,98,1,123,99],[7,73,45,3,74,46],[15,43,19,2,44,20],[3,45,15,13,46,16],[1,135,107,5,136,108],[10,74,46,1,75,47],[1,50,22,15,51,23],[2,42,14,17,43,15],[5,150,120,1,151,121],[9,69,43,4,70,44],[17,50,22,1,51,23],[2,42,14,19,43,15],[3,141,113,4,142,114],[3,70,44,11,71,45],[17,47,21,4,48,22],[9,39,13,16,40,14],[3,135,107,5,136,108],[3,67,41,13,68,42],[15,54,24,5,55,25],[15,43,15,10,44,16],[4,144,116,4,145,117],[17,68,42],[17,50,22,6,51,23],[19,46,16,6,47,17],[2,139,111,7,140,112],[17,74,46],[7,54,24,16,55,25],[34,37,13],[4,151,121,5,152,122],[4,75,47,14,76,48],[11,54,24,14,55,25],[16,45,15,14,46,16],[6,147,117,4,148,118],[6,73,45,14,74,46],[11,54,24,16,55,25],[30,46,16,2,47,17],[8,132,106,4,133,107],[8,75,47,13,76,48],[7,54,24,22,55,25],[22,45,15,13,46,16],[10,142,114,2,143,115],[19,74,46,4,75,47],[28,50,22,6,51,23],[33,46,16,4,47,17],[8,152,122,4,153,123],[22,73,45,3,74,46],[8,53,23,26,54,24],[12,45,15,28,46,16],[3,147,117,10,148,118],[3,73,45,23,74,46],[4,54,24,31,55,25],[11,45,15,31,46,16],[7,146,116,7,147,117],[21,73,45,7,74,46],[1,53,23,37,54,24],[19,45,15,26,46,16],[5,145,115,10,146,116],[19,75,47,10,76,48],[15,54,24,25,55,25],[23,45,15,25,46,16],[13,145,115,3,146,116],[2,74,46,29,75,47],[42,54,24,1,55,25],[23,45,15,28,46,16],[17,145,115],[10,74,46,23,75,47],[10,54,24,35,55,25],[19,45,15,35,46,16],[17,145,115,1,146,116],[14,74,46,21,75,47],[29,54,24,19,55,25],[11,45,15,46,46,16],[13,145,115,6,146,116],[14,74,46,23,75,47],[44,54,24,7,55,25],[59,46,16,1,47,17],[12,151,121,7,152,122],[12,75,47,26,76,48],[39,54,24,14,55,25],[22,45,15,41,46,16],[6,151,121,14,152,122],[6,75,47,34,76,48],[46,54,24,10,55,25],[2,45,15,64,46,16],[17,152,122,4,153,123],[29,74,46,14,75,47],[49,54,24,10,55,25],[24,45,15,46,46,16],[4,152,122,18,153,123],[13,74,46,32,75,47],[48,54,24,14,55,25],[42,45,15,32,46,16],[20,147,117,4,148,118],[40,75,47,7,76,48],[43,54,24,22,55,25],[10,45,15,67,46,16],[19,148,118,6,149,119],[18,75,47,31,76,48],[34,54,24,34,55,25],[20,45,15,61,46,16]];var qrRSBlock=function(totalCount,dataCount){var _this={};_this.totalCount=totalCount;_this.dataCount=dataCount;return _this};var _this={};var getRsBlockTable=function(typeNumber,errorCorrectionLevel){switch(errorCorrectionLevel){case QRErrorCorrectionLevel.L:return RS_BLOCK_TABLE[(typeNumber-1)*4+0];case QRErrorCorrectionLevel.M:return RS_BLOCK_TABLE[(typeNumber-1)*4+1];case QRErrorCorrectionLevel.Q:return RS_BLOCK_TABLE[(typeNumber-1)*4+2];case QRErrorCorrectionLevel.H:return RS_BLOCK_TABLE[(typeNumber-1)*4+3];default:return undefined}};_this.getRSBlocks=function(typeNumber,errorCorrectionLevel){var rsBlock=getRsBlockTable(typeNumber,errorCorrectionLevel);if(typeof rsBlock=='undefined'){throw'bad rs block @ typeNumber:'+typeNumber+'/errorCorrectionLevel:'+errorCorrectionLevel}var length=rsBlock.length/3;var list=[];for(var i=0;i<length;i+=1){var count=rsBlock[i*3+0];var totalCount=rsBlock[i*3+1];var dataCount=rsBlock[i*3+2];for(var j=0;j<count;j+=1){list.push(qrRSBlock(totalCount,dataCount))}}return list};return _this}();var qrNumber=function(data){var _mode=QRMode.MODE_NUMBER;var _data=data;var _this={};_this.getMode=function(){return _mode};_this.getLength=function(){return _data.length};_this.write=function(buffer){var data=_data;var i=0;while(i+2<data.length){buffer.put(strToNum(data.substring(i,i+3)),10);i+=3}if(i<data.length){if(data.length-i==1){buffer.put(strToNum(data.substring(i,i+1)),4)}else if(data.length-i==2){buffer.put(strToNum(data.substring(i,i+2)),7)}}};var strToNum=function(s){var num=0;for(var i=0;i<s.length;i+=1){num=num*10+chatToNum(s.charAt(i))}return num};var chatToNum=function(c){if('0'<=c&&c<='9'){return c.charCodeAt(0)-'0'.charCodeAt(0)}throw'illegal char :'+c};return _this};var qrAlphaNum=function(data){var _mode=QRMode.MODE_ALPHA_NUM;var _data=data;var _this={};_this.getMode=function(){return _mode};_this.getLength=function(){return _data.length};_this.write=function(buffer){var s=_data;var i=0;while(i+1<s.length){buffer.put(getCode(s.charAt(i))*45+getCode(s.charAt(i+1)),11);i+=2}if(i<s.length){buffer.put(getCode(s.charAt(i)),6)}};var getCode=function(c){if('0'<=c&&c<='9'){return c.charCodeAt(0)-'0'.charCodeAt(0)}else if('A'<=c&&c<='Z'){return c.charCodeAt(0)-'A'.charCodeAt(0)+10}else{switch(c){case' ':return 36;case'$':return 37;case'%':return 38;case'*':return 39;case'+':return 40;case'-':return 41;case'.':return 42;case'/':return 43;case':':return 44;default:throw'illegal char :'+c}}};return _this};var qr8BitByte=function(data){var _mode=QRMode.MODE_8BIT_BYTE;var _bytes=qrcode.stringToBytes(data);var _this={};_this.getMode=function(){return _mode};_this.getLength=function(){return _bytes.length};_this.write=function(buffer){for(var i=0;i<_bytes.length;i+=1){buffer.put(_bytes[i],8)}};return _this};var qrKanji=function(data){var _mode=QRMode.MODE_KANJI;var _bytes=qrcode.stringToBytesFuncs['SJIS']!=null?qrcode.stringToBytesFuncs['SJIS'](data):function(data){var bytes=[];for(var i=0;i<data.length;i+=1){bytes.push(data.charCodeAt(i))}return bytes}(data);var _this={};_this.getMode=function(){return _mode};_this.getLength=function(){return Math.floor(_bytes.length/2)};_this.write=function(buffer){var data=_bytes;var i=0;while(i+1<data.length){var c=((0xff&data[i])<<8)|(0xff&data[i+1]);if(0x8140<=c&&c<=0x9FFC){c-=0x8140}else if(0xE040<=c&&c<=0xEBBF){c-=0xC140}else{throw'illegal char at '+(i+1)+'/'+c}c=((c>>>8)&0xff)*0xC0+(c&0xff);buffer.put(c,13);i+=2}if(i<data.length){throw'illegal char at '+(i+1)}};return _this};var qrBitBuffer=function(){var _buffer=[];var _length=0;var _this={};_this.getBuffer=function(){return _buffer};_this.getAt=function(index){var bufIndex=Math.floor(index/8);return((_buffer[bufIndex]>>>(7-index%8))&1)==1};_this.put=function(num,length){for(var i=0;i<length;i+=1){_this.putBit(((num>>>(length-i-1))&1)==1)}};_this.getLengthInBits=function(){return _length};_this.putBit=function(bit){var bufIndex=Math.floor(_length/8);if(_buffer.length<=bufIndex){_buffer.push(0)}if(bit){_buffer[bufIndex]|=(0x80>>>(_length%8))}_length+=1};return _this};var gifImage=function(width,height){var _width=width;var _height=height;var _data=[];for(var y=0;y<_height;y+=1){_data[y]=[];for(var x=0;x<_width;x+=1){_data[y][x]=0}}var _this={};_this.setPixel=function(x,y,pixel){_data[y][x]=pixel};_this.write=function(out){out.writeString('GIF87a');out.writeShort(_width);out.writeShort(_height);out.writeByte(0x80);out.writeByte(0);out.writeByte(0);out.writeByte(0x00);out.writeByte(0x00);out.writeByte(0x00);out.writeByte(0xff);out.writeByte(0xff);out.writeByte(0xff);out.writeString(',');out.writeShort(0);out.writeShort(0);out.writeShort(_width);out.writeShort(_height);out.writeByte(0);var lzwMinCodeSize=2;var raster=getLZWRaster(lzwMinCodeSize);out.writeByte(lzwMinCodeSize);var offset=0;while(raster.length-offset>255){out.writeByte(255);for(var i=0;i<255;i+=1){out.writeByte(raster[offset+i])}offset+=255}out.writeByte(raster.length-offset);for(var i=0;i<raster.length-offset;i+=1){out.writeByte(raster[offset+i])}out.writeByte(0x00);out.writeString(';')};var bitOutputStream=function(out){var _out=out;var _bitLength=0;var _bitBuffer=0;var _this={};_this.write=function(data,length){if((data>>>length)!=0){throw'length over'}while(_bitLength+length>=8){_out.writeByte(0xff&((data<<_bitLength)|_bitBuffer));length-=(8-_bitLength);data>>>=(8-_bitLength);_bitBuffer=0;_bitLength=0}if(length>0){_bitBuffer=(data<<_bitLength)|_bitBuffer;_bitLength=_bitLength+length}};_this.flush=function(){if(_bitLength>0){_out.writeByte(_bitBuffer)}};return _this};var getLZWRaster=function(lzwMinCodeSize){var clearCode=1<<lzwMinCodeSize;var endCode=(1<<lzwMinCodeSize)+1;var bitLength=lzwMinCodeSize+1;var table=lzwTable();for(var i=0;i<clearCode;i+=1){table.add(String.fromCharCode(i))}table.add(String.fromCharCode(clearCode));table.add(String.fromCharCode(endCode));var byteOut=byteArrayOutputStream();var bitOut=bitOutputStream(byteOut);bitOut.write(clearCode,bitLength);var dataIndex=0;var s=String.fromCharCode(_data[0][0]);while(dataIndex<_width*_height){var c=dataIndex%_width;var r=Math.floor(dataIndex/_width);if(dataIndex+1<_width*_height){var nc=(dataIndex+1)%_width;var nr=Math.floor((dataIndex+1)/_width);var nextChar=String.fromCharCode(_data[nr][nc]);if(table.contains(s+nextChar)){s=s+nextChar}else{bitOut.write(table.indexOf(s),bitLength);if(table.size()<0xfff){if(table.size()==(1<<bitLength)){bitLength+=1}table.add(s+nextChar)}s=nextChar}}else{bitOut.write(table.indexOf(s),bitLength)}dataIndex+=1}bitOut.write(endCode,bitLength);bitOut.flush();return byteOut.toByteArray()};var lzwTable=function(){var _map={};var _size=0;var _this={};_this.add=function(key){if(_this.contains(key)){throw'dup key:'+key}_map[key]=_size;_size+=1};_this.size=function(){return _size};_this.indexOf=function(key){return _map[key]};_this.contains=function(key){return typeof _map[key]!='undefined'};return _this};var byteArrayOutputStream=function(){var _bytes=[];var _this={};_this.writeByte=function(b){_bytes.push(b&0xff)};_this.writeShort=function(i){_this.writeByte(i);_this.writeByte(i>>>8)};_this.writeString=function(s){for(var i=0;i<s.length;i+=1){_this.writeByte(s.charCodeAt(i))}};_this.toByteArray=function(){return _bytes};_this.toString=function(){var s='';s+='[';for(var i=0;i<_bytes.length;i+=1){if(i>0){s+=','}s+=_bytes[i]}s+=']';return s};return _this};_this.toDataURL=function(){var out=byteArrayOutputStream();_this.write(out);var bytes=out.toByteArray();var base64='';for(var i=0;i<bytes.length;i+=1){base64+=String.fromCharCode(bytes[i])}return'data:image/gif;base64,'+btoa(base64)};return _this};return qrcode}();
    </script>

    <script>
        var PORTAL_URL = 'https://trombonepunk81.github.io/ABC-Healthcare-Portal/';
        var currentQR = null;
        var batchQRs = [];

        window.addEventListener('DOMContentLoaded', function() {
            var status = document.getElementById('status-bar');
            if (typeof qrcode !== 'undefined') {
                status.textContent = '‚úì Ready to generate QR codes';
                status.className = 'status-bar success';
            } else {
                status.textContent = '‚úó QR library failed to load';
                status.className = 'status-bar error';
            }
        });

        function log(id, msg) {
            var el = document.getElementById(id);
            el.style.display = 'block';
            el.textContent += msg + '\n';
            console.log(msg);
        }

        function clearLog(id) {
            var el = document.getElementById(id);
            el.textContent = '';
            el.style.display = 'none';
        }

        function switchTab(name) {
            document.querySelectorAll('.tab').forEach(function(t) { t.classList.remove('active'); });
            document.querySelectorAll('.tab-content').forEach(function(t) { t.classList.remove('active'); });
            event.target.classList.add('active');
            document.getElementById(name + '-tab').classList.add('active');
        }

        function buildUrl(assetId, tandemUrl) {
            // Don't encode the tandem URL - it's already a valid URL
            // Just encode the asset ID in case it has special characters
            return PORTAL_URL + '?asset=' + encodeURIComponent(assetId) + '&tandem=' + encodeURIComponent(tandemUrl);
        }
        
        // For QR codes, we want the raw URL without heavy encoding
        function buildQRUrl(assetId, tandemUrl) {
            // Minimal encoding - just the asset ID for safety, tandem URL as-is
            return PORTAL_URL + '?asset=' + encodeURIComponent(assetId) + '&tandem=' + tandemUrl;
        }

        function createQRCanvas(text, cellSize) {
            cellSize = cellSize || 5;
            
            // Type 0 = auto-detect, 'L' = low error correction (max capacity)
            var qr = qrcode(0, 'L');
            qr.addData(text);
            qr.make();
            
            // Use the library's built-in image generation
            var dataUrl = qr.createDataURL(cellSize, cellSize * 4);
            
            // Create an image element and convert to canvas
            var img = new window.Image();
            var canvas = document.createElement('canvas');
            
            // We need to return synchronously, so use createImgTag approach
            var moduleCount = qr.getModuleCount();
            var margin = cellSize * 4;
            var size = moduleCount * cellSize + margin * 2;
            
            canvas.width = size;
            canvas.height = size;
            
            var ctx = canvas.getContext('2d');
            
            // Draw white background
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, size, size);
            
            // Draw QR modules
            ctx.fillStyle = '#000000';
            for (var row = 0; row < moduleCount; row++) {
                for (var col = 0; col < moduleCount; col++) {
                    if (qr.isDark(row, col)) {
                        ctx.fillRect(
                            margin + col * cellSize, 
                            margin + row * cellSize, 
                            cellSize, 
                            cellSize
                        );
                    }
                }
            }
            
            // Store the data URL for verification
            canvas.setAttribute('data-url', text);
            
            return canvas;
        }
        
        // Alternative: Create QR as image element using library's built-in method
        function createQRImage(text, cellSize) {
            cellSize = cellSize || 5;
            var qr = qrcode(0, 'L');
            qr.addData(text);
            qr.make();
            
            var img = document.createElement('img');
            img.src = qr.createDataURL(cellSize, cellSize * 4);
            img.setAttribute('data-url', text);
            return img;
        }

        function generateSingleQR() {
            clearLog('debug-single');
            log('debug-single', '=== Single QR Generation ===');

            var assetId = document.getElementById('asset-id').value.trim();
            var tandemUrl = document.getElementById('tandem-url').value.trim();

            if (!assetId || !tandemUrl) {
                alert('Please fill in both fields');
                return;
            }

            var fullUrl = buildQRUrl(assetId, tandemUrl);  // Use non-encoded version for QR
            log('debug-single', 'URL length: ' + fullUrl.length);

            try {
                var container = document.getElementById('qr-container');
                container.innerHTML = '';
                
                var canvas = createQRCanvas(fullUrl, 5);
                container.appendChild(canvas);

                document.getElementById('qr-asset-label').textContent = assetId;
                document.getElementById('qr-full-url').textContent = 'URL: ' + fullUrl;
                document.getElementById('single-output').classList.add('active');

                currentQR = { assetId: assetId, fullUrl: fullUrl, canvas: canvas };
                log('debug-single', 'Success!');

            } catch (err) {
                log('debug-single', 'ERROR: ' + err);
                alert('Error: ' + err);
            }
        }

        function downloadSingleQR() {
            if (!currentQR) return;
            
            var canvas = currentQR.canvas;
            var newCanvas = document.createElement('canvas');
            var ctx = newCanvas.getContext('2d');
            
            newCanvas.width = canvas.width + 40;
            newCanvas.height = canvas.height + 50;
            
            ctx.fillStyle = '#fff';
            ctx.fillRect(0, 0, newCanvas.width, newCanvas.height);
            ctx.drawImage(canvas, 20, 15);
            
            ctx.fillStyle = '#000';
            ctx.font = 'bold 14px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(currentQR.assetId, newCanvas.width / 2, canvas.height + 35);

            var link = document.createElement('a');
            link.download = 'QR-' + currentQR.assetId + '.png';
            link.href = newCanvas.toDataURL('image/png');
            link.click();
        }

        function importExcel(event) {
            var file = event.target.files[0];
            if (!file) return;

            if (typeof XLSX === 'undefined') {
                alert('Excel library not loaded. Please paste data manually.');
                return;
            }

            clearLog('debug-batch');
            log('debug-batch', 'Importing: ' + file.name);

            var reader = new FileReader();
            reader.onload = function(e) {
                try {
                    var data = new Uint8Array(e.target.result);
                    var workbook = XLSX.read(data, { type: 'array' });
                    var sheet = workbook.Sheets[workbook.SheetNames[0]];
                    var rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

                    var lines = [];
                    for (var i = 1; i < rows.length; i++) {
                        if (rows[i][0] && rows[i][1]) {
                            lines.push(rows[i][0] + ', ' + rows[i][1]);
                        }
                    }

                    document.getElementById('batch-data').value = lines.join('\n');
                    log('debug-batch', 'Imported ' + lines.length + ' rows');
                    alert('Imported ' + lines.length + ' assets!');

                } catch (err) {
                    log('debug-batch', 'Error: ' + err.message);
                    alert('Error reading file: ' + err.message);
                }
            };
            reader.readAsArrayBuffer(file);
            event.target.value = '';
        }

        function downloadTemplate() {
            if (typeof XLSX === 'undefined') {
                alert('Excel library not loaded.');
                return;
            }
            var wb = XLSX.utils.book_new();
            var ws = XLSX.utils.aoa_to_sheet([
                ['Asset ID', 'Tandem URL'],
                ['CAM.E1879-A.01', 'https://tandem.autodesk.com/pages/facilities/...'],
                ['HVAC.B2201-C.05', 'https://tandem.autodesk.com/pages/facilities/...']
            ]);
            ws['!cols'] = [{ wch: 20 }, { wch: 60 }];
            XLSX.utils.book_append_sheet(wb, ws, 'Assets');
            XLSX.writeFile(wb, 'QR-Template.xlsx');
        }

        function generateBatchQR() {
            clearLog('debug-batch');
            log('debug-batch', '=== Batch Generation ===');

            var text = document.getElementById('batch-data').value.trim();
            if (!text) {
                alert('Please enter data or import Excel');
                return;
            }

            var lines = text.split('\n').filter(function(l) { return l.trim(); });
            log('debug-batch', 'Total lines: ' + lines.length);
            
            // Skip header row if present
            if (lines.length > 0) {
                var firstLine = lines[0].toLowerCase();
                if (firstLine.indexOf('asset') >= 0 && firstLine.indexOf('url') >= 0) {
                    log('debug-batch', 'Skipping header');
                    lines = lines.slice(1);
                }
            }

            batchQRs = [];
            var container = document.getElementById('batch-results');
            container.innerHTML = '';

            for (var i = 0; i < lines.length; i++) {
                var line = lines[i];
                log('debug-batch', '--- Line ' + (i+1) + ' ---');

                var parts;
                if (line.indexOf('\t') >= 0) {
                    parts = line.split('\t');
                } else {
                    parts = line.split(',');
                }
                parts = parts.map(function(p) { return p.trim(); });

                if (parts.length < 2 || !parts[0] || !parts[1]) {
                    log('debug-batch', 'SKIP: missing data');
                    continue;
                }

                var assetId = parts[0];
                var tandemUrl = parts.slice(1).join(',').trim();
                var fullUrl = buildQRUrl(assetId, tandemUrl);  // Use non-encoded version for QR
                
                log('debug-batch', 'Asset: ' + assetId + ', URL len: ' + fullUrl.length);

                try {
                    var div = document.createElement('div');
                    div.className = 'batch-item';

                    var canvas = createQRCanvas(fullUrl, 4);  // Slightly smaller for grid but still readable
                    log('debug-batch', 'QR OK');

                    var label = document.createElement('div');
                    label.className = 'batch-item-label';
                    label.textContent = assetId;

                    var btn = document.createElement('button');
                    btn.className = 'batch-item-download';
                    btn.textContent = 'Download';
                    (function(aid, cvs) {
                        btn.onclick = function() { downloadOne(aid, cvs); };
                    })(assetId, canvas);

                    div.appendChild(canvas);
                    div.appendChild(label);
                    div.appendChild(btn);
                    container.appendChild(div);

                    batchQRs.push({ assetId: assetId, canvas: canvas });

                } catch (err) {
                    log('debug-batch', 'ERROR: ' + err);
                }
            }

            log('debug-batch', '=== Done: ' + batchQRs.length + ' QR codes ===');

            if (batchQRs.length > 0) {
                document.getElementById('batch-output').classList.add('active');
            } else {
                alert('No QR codes generated. Check format.');
            }
        }

        function downloadOne(assetId, canvas) {
            var newCanvas = document.createElement('canvas');
            var ctx = newCanvas.getContext('2d');
            newCanvas.width = canvas.width + 30;
            newCanvas.height = canvas.height + 40;
            ctx.fillStyle = '#fff';
            ctx.fillRect(0, 0, newCanvas.width, newCanvas.height);
            ctx.drawImage(canvas, 15, 10);
            ctx.fillStyle = '#000';
            ctx.font = 'bold 12px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(assetId, newCanvas.width / 2, canvas.height + 28);

            var link = document.createElement('a');
            link.download = 'QR-' + assetId + '.png';
            link.href = newCanvas.toDataURL('image/png');
            link.click();
        }

        function downloadAllZip() {
            if (!batchQRs.length) return;
            
            if (typeof JSZip === 'undefined') {
                alert('ZIP library not available. Download individually.');
                return;
            }

            var zip = new JSZip();

            for (var i = 0; i < batchQRs.length; i++) {
                var item = batchQRs[i];
                var newCanvas = document.createElement('canvas');
                var ctx = newCanvas.getContext('2d');
                newCanvas.width = item.canvas.width + 30;
                newCanvas.height = item.canvas.height + 40;
                ctx.fillStyle = '#fff';
                ctx.fillRect(0, 0, newCanvas.width, newCanvas.height);
                ctx.drawImage(item.canvas, 15, 10);
                ctx.fillStyle = '#000';
                ctx.font = 'bold 12px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(item.assetId, newCanvas.width / 2, item.canvas.height + 28);

                var dataUrl = newCanvas.toDataURL('image/png');
                zip.file('QR-' + item.assetId + '.png', dataUrl.split(',')[1], { base64: true });
            }

            zip.generateAsync({ type: 'blob' }).then(function(blob) {
                var link = document.createElement('a');
                link.download = 'QR-Codes.zip';
                link.href = URL.createObjectURL(blob);
                link.click();
            });
        }
    </script>
</body>
</html>
